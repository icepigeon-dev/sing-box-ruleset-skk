name: Sync and Compile Sing-box Rule-sets

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2:00 UTC è‡ªåŠ¨åŒæ­¥
    - cron: "0 2 * * *"
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [main, master]
    paths:
      - "sing-box/**/*.json"

jobs:
  sync-and-compile:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to push changes back to the repository

    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ç¨€ç–æ£€å‡ºæºä»“åº“ sing-box ç›®å½•
        run: |
          echo "ðŸ”„ å¼€å§‹ç¨€ç–æ£€å‡º sing-box ç›®å½•..."
          # Create temporary directory
          mkdir -p temp-source
          cd temp-source

          # Initialize git repository
          git init
          git remote add origin https://github.com/SukkaLab/ruleset.skk.moe.git

          # Configure sparse checkout, only get sing-box directory
          git config core.sparseCheckout true
          echo "sing-box/*" > .git/info/sparse-checkout

          # Pull only the latest commit (depth 1, save time and bandwidth)
          git pull --depth=1 origin master

          # Get current commit hash
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "SOURCE_COMMIT=$CURRENT_COMMIT" >> $GITHUB_ENV
          echo "âœ… ç¨€ç–æ£€å‡ºå®Œæˆï¼Œæäº¤å“ˆå¸Œ: ${CURRENT_COMMIT:0:7}"

          cd ..

      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
        id: check_updates
        run: |
          # Check last synced commit record
          if [ -f "last_sync_commit.txt" ]; then
            LAST_COMMIT=$(cat last_sync_commit.txt)
            echo "ä¸Šæ¬¡åŒæ­¥æäº¤: $LAST_COMMIT"
          else
            LAST_COMMIT=""
            echo "é¦–æ¬¡åŒæ­¥"
          fi

          echo "å½“å‰æºæäº¤: $SOURCE_COMMIT"

          if [ "$LAST_COMMIT" != "$SOURCE_COMMIT" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "âœ… å‘çŽ°æ–°çš„æ›´æ–°"
            
            # Calculate file changes
            if [ -d "sing-box" ]; then
              OLD_COUNT=$(find sing-box -name "*.json" -type f 2>/dev/null | wc -l)
            else
              OLD_COUNT=0
            fi
            NEW_COUNT=$(find temp-source/sing-box -name "*.json" -type f 2>/dev/null | wc -l)
            echo "OLD_FILE_COUNT=$OLD_COUNT" >> $GITHUB_ENV
            echo "NEW_FILE_COUNT=$NEW_COUNT" >> $GITHUB_ENV
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ æ²¡æœ‰æ–°çš„æ›´æ–°"
          fi

      - name: åŒæ­¥ sing-box ç›®å½•
        if: steps.check_updates.outputs.has_updates == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "ðŸ”„ åŒæ­¥ sing-box ç›®å½•..."

          # Remove old sing-box directory
          rm -rf sing-box/

          # Copy new sing-box directory
          cp -r temp-source/sing-box ./

          # Record current synced commit
          echo "$SOURCE_COMMIT" > last_sync_commit.txt

          echo "âœ… åŒæ­¥å®Œæˆ"
          echo "ðŸ“Š JSON æ–‡ä»¶æ•°é‡: $(find sing-box -name "*.json" -type f 2>/dev/null | wc -l)"

      - name: å®‰è£… sing-box
        if: steps.check_updates.outputs.has_updates == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "â¬‡ï¸ å®‰è£… sing-box..."

          # Get latest version
          LATEST_VERSION=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          echo "ðŸ“¦ å®‰è£…ç‰ˆæœ¬: $LATEST_VERSION"

          # Download and extract
          wget -q https://github.com/SagerNet/sing-box/releases/download/$LATEST_VERSION/sing-box-${LATEST_VERSION#v}-linux-amd64.tar.gz
          tar -xzf sing-box-${LATEST_VERSION#v}-linux-amd64.tar.gz
          sudo mv sing-box-${LATEST_VERSION#v}-linux-amd64/sing-box /usr/local/bin/

          # Clean up downloaded files
          rm -rf sing-box-${LATEST_VERSION#v}-linux-amd64*

          # Verify installation
          sing-box version
          echo "âœ… sing-box å®‰è£…å®Œæˆ"

      - name: ç¼–è¯‘è§„åˆ™é›†æ–‡ä»¶
        if: steps.check_updates.outputs.has_updates == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "ðŸ”¨ å¼€å§‹ç¼–è¯‘è§„åˆ™é›†æ–‡ä»¶..."

          # Count files
          json_files=$(find sing-box -name "*.json" -type f)
          json_count=$(echo "$json_files" | wc -l)
          echo "ðŸ“ æ‰¾åˆ° $json_count ä¸ª JSON è§„åˆ™æ–‡ä»¶"

          # Compile counters
          compiled_success=0
          compiled_failed=0

          # Compile each JSON file
          echo "$json_files" | while read -r json_file; do
            if [ -n "$json_file" ]; then
              echo "ðŸ”„ å¤„ç†: $json_file"
              srs_file="${json_file%.json}.srs"
              
              if timeout 30 sing-box rule-set compile --output "$srs_file" "$json_file" 2>/dev/null; then
                file_size=$(ls -lh "$srs_file" | awk '{print $5}')
                echo "  âœ… ç¼–è¯‘æˆåŠŸ: $srs_file ($file_size)"
                compiled_success=$((compiled_success + 1))
              else
                echo "  âŒ ç¼–è¯‘å¤±è´¥: $json_file"
                compiled_failed=$((compiled_failed + 1))
              fi
            fi
          done

          # Final statistics
          srs_count=$(find sing-box -name "*.srs" -type f 2>/dev/null | wc -l)
          echo ""
          echo "ðŸ“Š ç¼–è¯‘ç»Ÿè®¡:"
          echo "  - JSON æºæ–‡ä»¶: $json_count"
          echo "  - SRS ç¼–è¯‘æ–‡ä»¶: $srs_count"
          echo "  - ç¼–è¯‘æˆåŠŸ: $compiled_success"
          echo "  - ç¼–è¯‘å¤±è´¥: $compiled_failed"

          if [ "$compiled_failed" -gt 0 ]; then
            echo "âš ï¸ æœ‰æ–‡ä»¶ç¼–è¯‘å¤±è´¥ï¼Œä½†ç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶"
          fi

          echo "COMPILED_COUNT=$srs_count" >> $GITHUB_ENV

      - name: ç”Ÿæˆ index.html æ–‡æ¡£
        if: steps.check_updates.outputs.has_updates == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "ðŸ“ Generating index.html..."
          LAST_BUILD_TIME=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
          # This prefix is taken directly from your provided index.html.
          # It implies a specific deployment path or domain configuration.
          HTML_LINK_PREFIX="/sing-box-ruleset-skk" # Adjust if your repo name or Pages path is different

          cat > index.html <<EOL
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <title>Sing-box Ruleset Server | Sukka (@SukkaW)</title>
            <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
            <link href="https://cdn.skk.moe/favicon.ico" rel="icon" type="image/ico">
            <link href="https://cdn.skk.moe/favicon/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
            <link href="https://cdn.skk.moe/favicon/android-chrome-192x192.png" rel="icon" type="image/png" sizes="192x192">
            <link href="https://cdn.skk.moe/favicon/favicon-32x32.png" rel="icon" type="image/png" sizes="32x32">
            <link href="https://cdn.skk.moe/favicon/favicon-16x16.png" rel="icon" type="image/png" sizes="16x16">
            <meta name="description" content="Sukka è‡ªç”¨çš„ Surge / Clash Premium è§„åˆ™ç»„ (Sing-boxäºŒè¿›åˆ¶ç‰ˆæœ¬)">
            <link rel="stylesheet" href="https://cdn.skk.moe/ruleset/css/21d8777a.css" />
            <meta property="og:title" content="Surge Ruleset | Sukka (@SukkaW)">
            <meta property="og:type" content="Website">
            <meta property="og:url" content="https://ruleset.skk.moe/">
            <meta property="og:image" content="https://cdn.skk.moe/favicon/android-chrome-192x192.png">
            <meta property="og:description" content="Sukka è‡ªç”¨çš„ Surge / Clash Premium è§„åˆ™ç»„ (Sing-boxäºŒè¿›åˆ¶ç‰ˆæœ¬)">
            <meta name="twitter:card" content="summary">
            <link rel="canonical" href="https://ruleset.skk.moe/">
          </head>
          <body>
            <main class="container">
              <h1>Sukka Ruleset Server</h1>
              <p>
                Made by <a href="https://skk.moe">Sukka</a> | <a href="https://github.com/SukkaW/Surge/">Source @ GitHub</a> |
                Licensed under <a href="/LICENSE" target="_blank">AGPL-3.0</a>
              </p>
              <p>Last Build: $LAST_BUILD_TIME</p>
              <br>
              <ul class="directory-list">
                <li class="folder">
                  sing-box
                  <ul>
          EOL

          if [ -d "sing-box" ]; then
            # Process subdirectories first
            find sing-box -mindepth 1 -maxdepth 1 -type d | sort | while read -r subdir_path; do
              subdir_name=$(basename "$subdir_path")
              echo "            <li class=\"folder\">" >> index.html
              echo "              $subdir_name" >> index.html
              echo "              <ul>" >> index.html
              find "$subdir_path" -name "*.srs" -type f | sort | while read -r srs_file; do
                # Path relative to the sing-box directory for the link
                relative_srs_path_to_singbox_dir="${srs_file#sing-box/}"
                file_name=$(basename "$srs_file")
                echo "                <li><a class=\"file directory-list-file\" href=\"$HTML_LINK_PREFIX/sing-box/$relative_srs_path_to_singbox_dir\">$file_name</a></li>" >> index.html
              done
              echo "              </ul>" >> index.html
              echo "            </li>" >> index.html
            done

            # Process files directly under sing-box (if any, though your example doesn't show this)
            find sing-box -maxdepth 1 -name "*.srs" -type f | sort | while read -r srs_file; do
              file_name=$(basename "$srs_file")
              echo "            <li><a class=\"file directory-list-file\" href=\"$HTML_LINK_PREFIX/sing-box/$file_name\">$file_name</a></li>" >> index.html
            done
          else
            echo "            <li>No sing-box rulesets found.</li>" >> index.html
          fi

          cat >> index.html <<EOL
                  </ul>
                </li>
              </ul>
            </main>
          </body>
          </html>
          EOL
          echo "âœ… index.html documentation generated successfully."

      # MOVED CLEANUP STEP HERE - BEFORE COMMIT
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always() # Ensures cleanup even if previous steps fail, but critically before commit
        run: |
          echo "ðŸ§¹ å¼€å§‹æ¸…ç†ä¸´æ—¶æ–‡ä»¶ temp-source..."
          rm -rf temp-source
          echo "ðŸ§¹ æ¸…ç†å®Œæˆ"

      - name: æäº¤æ›´æ–°
        if: steps.check_updates.outputs.has_updates == 'true' || github.event_name == 'workflow_dispatch'
        env:
          SOURCE_COMMIT: ${{ env.SOURCE_COMMIT }}
          COMPILED_COUNT: ${{ env.COMPILED_COUNT }}
          OLD_FILE_COUNT: ${{ env.OLD_FILE_COUNT }}
          NEW_FILE_COUNT: ${{ env.NEW_FILE_COUNT }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add all changes (temp-source should be gone now)
          git add . 
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
          else
            commit_msg="ðŸ¤– è‡ªåŠ¨åŒæ­¥å¹¶ç¼–è¯‘è§„åˆ™é›†

            ðŸ“… åŒæ­¥æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            ðŸ“ æºæäº¤: ${SOURCE_COMMIT:0:7}
            ðŸ“Š è§„åˆ™é›†æ•°é‡: $COMPILED_COUNT
            ðŸ“ JSONæ–‡ä»¶å˜åŒ–: $OLD_FILE_COUNT â†’ $NEW_FILE_COUNT

            è‡ªåŠ¨å¤„ç†å†…å®¹:
            - ç¨€ç–æ£€å‡º sing-box ç›®å½•
            - ç¼–è¯‘ JSON è§„åˆ™é›†ä¸ºäºŒè¿›åˆ¶æ ¼å¼
            - æ›´æ–° index.html æ–‡æ¡£" # Removed README.md update from commit message

            git commit -m "$commit_msg"
            git push
            echo "âœ… æ›´æ–°å·²æäº¤å¹¶æŽ¨é€"
          fi

      - name: ç”Ÿæˆæž„å»ºæ‘˜è¦
        if: always()
        env:
          SOURCE_COMMIT: ${{ env.SOURCE_COMMIT }} # Ensure env vars are available
          COMPILED_COUNT: ${{ env.COMPILED_COUNT }}
        run: |
          if [ "${{ steps.check_updates.outputs.has_updates }}" == "true" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TOTAL_SIZE_RAW=$(du -sh sing-box 2>/dev/null)
            TOTAL_SIZE=$(echo "$TOTAL_SIZE_RAW" | cut -f1)
            if [ -z "$TOTAL_SIZE" ]; then TOTAL_SIZE="N/A"; fi
            echo "## ðŸŽ‰ æž„å»ºå®Œæˆæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ• æž„å»ºæ—¶é—´ | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
            # Make sure SOURCE_COMMIT is available, if not, retrieve from env or an earlier step's output
            echo "| ðŸ“ æºæäº¤ | [\`${SOURCE_COMMIT:0:7}\`](https://github.com/SukkaLab/ruleset.skk.moe/commit/$SOURCE_COMMIT) |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“Š ç¼–è¯‘æ–‡ä»¶ | $COMPILED_COUNT ä¸ªè§„åˆ™é›† |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“ æ€»å¤§å° | $TOTAL_SIZE |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **æ‰€æœ‰è§„åˆ™é›†å·²æˆåŠŸç¼–è¯‘å¹¶æ›´æ–°ï¼**" >> $GITHUB_STEP_SUMMARY
          else
            echo "## â„¹ï¸ æ— éœ€æ›´æ–°" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å½“å‰è§„åˆ™é›†å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€é‡æ–°ç¼–è¯‘ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ä¸Šä¼ ç¼–è¯‘ç»“æžœ
        if: steps.check_updates.outputs.has_updates == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: sing-box-rulesets-${{ github.run_number }}
          path: |
            sing-box/**/*.srs
            index.html 
            last_sync_commit.txt
          retention-days: 30
          compression-level: 9
